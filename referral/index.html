<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Viewpoint Referral Hub</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Icons -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">

  <!-- Confetti -->
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

  <style>
    :root{
      --blue:#3057A4; --ink:#222; --muted:#6b7280; --bg:#f5f7fa; --card:#fff; --border:#e6e9f2;
      --btn:#3057A4; --btn-alt:#eef2ff; --btn-alt-ink:#1f2a59;
      --green: #28a745;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:var(--bg);color:var(--ink)}
    .wrap{max-width:980px;margin:32px auto;padding:0 16px}
    .card{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:18px 20px}
    h1{font-size:22px;margin:8px 0 4px}
    h2{font-size:16px;margin:0 0 6px;color:var(--muted)}
    .stat{font-size:32px;font-weight:600}
    .earnings{color:var(--green)}
    .muted{color:var(--muted)}
    .kpis{display:flex;gap:18px;flex-wrap:wrap;margin-top:8px}
    .kpi{font-size:14px}
    .kpi strong{font-size:16px}

    .earn-flex{display:flex;gap:24px;align-items:flex-start;justify-content:space-between;flex-wrap:wrap}
    .earn-left{min-width:260px}
    .earn-right{min-width:300px;max-width:460px}
    .box{border:1px dashed var(--border);border-radius:12px;padding:12px}

    .btn{display:inline-flex;align-items:center;gap:8px;border:none;background:var(--btn);color:#fff;padding:12px 16px;border-radius:10px;font-weight:600;cursor:pointer;text-decoration:none}
    .btn svg{width:18px;height:18px;flex:0 0 18px}
    .btn.secondary{background:var(--btn-alt);color:var(--btn-alt-ink);border:1px solid #cdd5ff}
    .btn.secondary#copyBtn{padding:6px 6px;border-radius:50%;background:transparent;}
    .btn.secondary#copyBtn:hover{background:var(--btn-alt);}
    label{display:block;font-size:12px;color:var(--muted);margin:10px 0 6px}
    input,select{width:100%;padding:10px;border:1px solid var(--border);border-radius:10px}

    .range-row{display:flex;align-items:center;gap:10px;margin-top:16px}
    .range-row .count-pill{margin-left:auto;background:#eef2ff;color:#1f2a59;border:1px solid #cdd5ff;border-radius:999px;padding:6px 10px;font-weight:700;font-size:12px}
    input[type="range"]{width:100%;appearance:none;height:6px;border-radius:999px;background:#e9edf7;outline:none;padding:0}
    input[type="range"]::-webkit-slider-thumb{appearance:none;width:18px;height:18px;border-radius:50%;background:var(--blue);cursor:pointer}
    input[type="range"]::-moz-range-thumb{width:18px;height:18px;border-radius:50%;background:var(--blue);cursor:pointer;border:none}

    .tabs{margin-top:16px}
    .tabbar{display:flex;gap:8px;margin-bottom:12px;flex-wrap:wrap;justify-content: center;}
    .tabbtn{padding:10px 14px;border-radius:10px;border:1px solid var(--border);background:#fff;cursor:pointer;font-weight:600;max-width: 45%;}
    .tabbtn[aria-selected="true"]{background:#eef2ff;border-color:#cdd5ff;color:#1f2a59}
    .tabpanel{display:none}
    .tabpanel.active{display:block}

    .inline{display:inline-flex;gap:8px;align-items:center;flex-wrap:wrap}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace}
    .link-str{font-weight:600;word-break:break-all}

    .list{margin-top:12px;border-top:1px dashed var(--border)}
    .item{display:flex;justify-content:space-between;gap:12px;padding:10px 0;border-bottom:1px dashed var(--border)}
    .badge{font-size:12px;padding:4px 8px;border-radius:999px;background:#eef2ff;color:#1f2a59}
    .badge-success{background:#d1fae5;color:#065f46}
    .badge-neutral{background:#e5e7eb;color:#374151}
        /* .badge-success{background:#e6f9ef;color:#166534;border:1px solid #6ee7b7;font-weight:600} */

    /* tooltip */
    .tooltip-wrapper{position:relative;display:inline-flex;align-items:center;cursor:pointer}
    .tooltip-bubble{
      visibility:hidden;opacity:0;position:absolute;z-index:1000;
      bottom:125%;left:50%;transform:translateX(-50%);
      background:#111;color:#fff;font-size:12px;border-radius:6px;padding:6px 8px;
      white-space:nowrap;pointer-events:none;transition:opacity .2s ease, transform .2s ease
    }
    .tooltip-wrapper:hover .tooltip-bubble{visibility:visible;opacity:1;transform:translateX(-50%) translateY(-4px)}
    .tooltip-bubble::after{
      content:"";position:absolute;top:100%;left:50%;margin-left:-5px;
      border-width:5px;border-style:solid;border-color:#111 transparent transparent transparent
    }
    .tooltip-bubble[data-placement="bottom"]{
      bottom:auto;top:125%;transform:translateX(-50%) translateY(4px)
    }
    .tooltip-bubble[data-placement="bottom"]::after{
      top:auto;bottom:100%;border-color:transparent transparent #111 transparent
    }
    .text-warning { color: #d9534f; font-weight: 600; }
.loader-block {
  padding: 12px 0;
  display: flex;
  flex-direction: column;
  gap: 8px;
}

.loader-line {
  height: 12px;
  width: 100%;
  background: #e5e7eb;
  border-radius: 4px;
  overflow: hidden;
  position: relative;
}

.loader-line.short {
  width: 60%;
}

.shimmer::after {
  content: "";
  position: absolute;
  top: 0;
  left: -40%;
  width: 40%;
  height: 100%;
  background: linear-gradient(
    90deg,
    rgba(255,255,255,0) 0%,
    rgba(255,255,255,0.6) 50%,
    rgba(255,255,255,0) 100%
  );
  animation: shimmer 1.2s infinite;
}

@keyframes shimmer {
  0% { left: -40%; }
  100% { left: 100%; }
}

  </style>
</head>

<body>
<div class="wrap">

  <!-- Earnings card -->
  <div class="card" style="grid-column: 1 / -1;">
    <div class="earn-flex">
      <div class="earn-left">
        <h2>Your earnings</h2>
        <div class="stat earnings" id="earned">$0</div>
        <div class="kpis" id="kpis">
          <div class="kpi muted">Pending<br><strong id="pending">$0</strong></div>
        </div>
      </div>

      <!-- Potential earnings -->
      <div class="earn-right">
        <h2>Potential earnings</h2>
        <div class="box">
          <label for="refType">Referral type</label>
          <select id="refType">
            <option value="cold">We reach out ($75 each)</option>
            <option value="pre">They call us ($250 each)</option>
          </select>

          <div class="range-row">
            <label for="countRange" style="margin:0;color:var(--muted)">How many likely referrals?</label>
            <span class="count-pill" id="countVal">1</span>
          </div>
          <input id="countRange" type="range" min="1" max="500" step="1" value="1" />

          <div style="margin-top:10px">
            <div class="muted" id="bonusNote">Bonuses: 3 = +$50, 5 = +$150, 10 = +$500.</div>
            <div style="margin-top:6px;font-weight:700">Estimated: <span id="estimate">$75</span></div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Tabs -->
  <div class="card" style="grid-column: 1 / -1; margin-top:16px ">
    <div class="tabs">
      <div class="tabbar" role="tablist">
        <button class="tabbtn" id="tab-cold" role="tab" aria-selected="true">Add contact (we reach out)</button>
        <button class="tabbtn" id="tab-pre"  role="tab" aria-selected="false">Share link (they call us)</button>
      </div>

      <!-- Tab A -->
      <section id="panel-cold" class="tabpanel active" role="tabpanel" aria-labelledby="tab-cold">
        <h1>Add a referral</h1>
        <p class="muted" style="margin:0 0 12px;">
          Enter a name and phone. You earn <strong>$75</strong> per signup.
          <span class="tooltip-wrapper">
            <i class="bi bi-info-circle" style="font-size:15px;color:#6b7280"></i>
            <span class="tooltip-bubble">Bonuses: +$15 at 3, +$50 at 5, +$150 at 10.</span>
          </span>
        </p>

        <label for="prospectName">Full name</label>
        <input id="prospectName" placeholder="e.g., Sarah Cohen" />
        <label for="prospectPhone">Phone</label>
        <input id="prospectPhone" placeholder="e.g., 347-555-0188" />
        <label for="prospectEmail" class="muted">Email (optional)</label>
        <input id="prospectEmail" placeholder="e.g., sarah@email.com" />
        <div style="margin-top:12px">
          <button class="btn" id="addBtn" type="button">Add referral</button>
        </div>
      </section>

      <!-- Tab B -->
      <section id="panel-pre" class="tabpanel" role="tabpanel" aria-labelledby="tab-pre">
        <h1>Share your referral link</h1>
        <p class="muted" style="margin:0 0 12px;">
          Share your link or have them mention your name. You earn <strong>$250</strong> per signup.
          <span class="tooltip-wrapper">
            <i class="bi bi-info-circle" style="font-size:15px;color:#6b7280"></i>
            <span class="tooltip-bubble">Bonuses: +$50 at 3, +$150 at 5, +$500 at 10.</span>
          </span>
        </p>

        <!-- Controls -->
        <div class="inline" style="margin-bottom:8px">
          <span style="display: none;"><a id="openLinkBtn" class="btn" href="#" target="_blank" rel="noopener" aria-label="Open referral link" style="display:none">
            Open link
          </a> </span>
          <button id="generateBtn" class="btn" type="button" style="display:none">Generate link</button>
          <button id="retryBtn" class="btn secondary" type="button" style="display:none">Try again</button>
        </div>

        <!-- Link / status -->
         <!-- inset div with flex vide grid left and right colum  -->
          <div style="display:flex;align-items:center;gap:4px">
              <div class="mono link-str" id="refLink" style="min-height:22px"></div>
              <!-- svg in the button -->
              <div>
                <div>
                <span class="tooltip-wrapper">
                  <button id="copyBtn" class="btn secondary" type="button" aria-label="Copy referral link" style="display:none;">
                 <img src="./copy.svg" alt="Copy" width="16" height="16" />                   
                  </button>
                <span class="tooltip-bubble">Copy Link</span>
              </span>

                </div>
              </div>
          </div>
        <div class="muted" id="linkStatus" style="font-size:12px;margin-top:4px"></div>
<script>
document.getElementById('copyBtn').addEventListener('click', () => {
    const copyBtn = document.getElementById('copyBtn');
    const img = copyBtn.querySelector('img');
    const transitionDuration = 100;
    img.style.opacity = 0;

    setTimeout(() => {
        img.src = './check.svg';
        img.style.opacity = 1;
        setTimeout(() => {
            img.style.opacity = 0;
            setTimeout(() => {
                img.src = './copy.svg';
                img.style.opacity = 1;
            }, transitionDuration);

        }, 3000); // How long the "check" icon stays visible

    }, transitionDuration);
});
</script>
        <!-- Share buttons -->
        <div class="inline" style="margin-top:8px">
          <a id="waBtn" class="btn secondary" href="#" target="_blank" rel="noopener" aria-label="Share via WhatsApp" style="display:none"> <img src="./whatsapp.svg" alt="Copy" width="20" height="20" />                   
WhatsApp</a>
          <a id="smsBtn" class="btn secondary" href="#" target="_blank" rel="noopener" aria-label="Share via SMS" style="display:none"> <img src="./sms.svg" alt="Copy" width="20" height="20" />                   
SMS</a>
        </div>
      </section>

    </div>
  </div>
  <div class="card" style="grid-column: 1 / -1; margin-top:16px ">
      <div style="margin-top:18px">
        <h1>Your referrals</h1>
        <div class="list" id="refList">
          <div class="item muted"><span>No referrals yet.</span><span></span></div>
        </div>
      </div>
    </div>
</div>

<script>
  // ---------- config ----------
  const RATE_PRE  = 250; // they call us
  const RATE_COLD = 75;  // we reach out
  const MILESTONES_PRE  = [{n:3, bonus:50},{n:5, bonus:150},{n:10, bonus:500}];
  const MILESTONES_COLD = [{n:3, bonus:15},{n:5, bonus:50},{n:10, bonus:150}];

  // ---------- state ----------
  const state = {
    referrerEmail: null,
    actId: null,   // full internal id (private)
    refCode: null, // public vrp if needed (legacy)
    earned: 0,
    pending: 0,
    referrals: [] // {name, phone, email, status, type}
  };

  // ---------- params ----------
  const qs = new URLSearchParams(location.search);
  state.referrerEmail = qs.get("siq_email") || null;
  const rawActId = (qs.get("contact_id") || "").trim();
  state.actId = rawActId || null;
  const actDigits = (rawActId || "").replace(/\D/g,"");
  state.refCode = actDigits.slice(-5) || (state.referrerEmail ? btoa(state.referrerEmail).replace(/=+$/,"").slice(0,5) : "XXXXX");

  // ---------- helpers ----------
  function flash(){ confetti({particleCount:120, spread:65, origin:{y:0.6}}); }

  function calcEstimate(count, type){
    const rate = type === "pre" ? RATE_PRE : RATE_COLD;
    const ladder = type === "pre" ? MILESTONES_PRE : MILESTONES_COLD;
    let total = count * rate;
    ladder.forEach(m => { if(count >= m.n) total += m.bonus; });
    return `$${total.toLocaleString()}`;
  }

  function ladderText(arr){
    return "Bonuses: " + arr.map(m => `${m.n} = +$${m.bonus}`).join(", ") + ".";
  }

  function renderMoney(){
    document.getElementById("earned").textContent    = `$${state.earned.toLocaleString()}`;
    document.getElementById("pending").textContent   = `$${state.pending.toLocaleString()}`;
  }
  
  // ---------- fetch referrals ----------
  //https://zoho-proxy.ephraim-7a6.workers.dev/getreferrals
  //https://zoho-proxy.ephraim-7a6.workers.dev/referrals?contact_id=4449829000036800352
  //eg: {"status":"ok","vendor_Id":4449829000062431700,"count":3,"items":[{"Type":"Contact","Name":"Aron Weissmandl","Id":"4449829000070459931","Phone":"8458282812","Email":"rabbiweissmandl@gmail.com","Referral_Method":""},{"Type":"DealWon","Id":"4449829000060423035","Name":"Sruly Scharf","Phone":"+19296172661","Email":"srulyscharf@gmail.com","Referral_Amount":587.5,"Referral_Method":"Phone In"},{"Type":"DealWon","Id":"4449829000055592036","Name":"Jonathan Pasternak","Phone":"+1845-263-0329","Email":"jonathanpasternak70@gmail.com","Referral_Amount":0,"Referral_Method":"Phone In"}]}
  //create function getRefs() that fetches the referrals and updates the state.referrals array


  function normalizeRefResponse(data){
  // supports both {status, items} and {status, message:{items}}
  if (data && data.message && Array.isArray(data.message.items)) {
    return { ok: data.status === 'ok', items: data.message.items };
  }
  return { ok: data && data.status === 'ok' && Array.isArray(data.items), items: (data && data.items) || [] };
}

function mapTypeByMethod(method){
  const m = (method || '').toLowerCase();
  if (m.includes('link') || m.includes('phone in') || m.includes('name only')) return 'inreach';
  return 'outreach';
}


function renderLoaderRefs() {
  const list = document.getElementById("refList");

  list.innerHTML = `
    <div class="loader-block">
      <div class="loader-line shimmer" style="height:20px;" ></div>
      <div class="loader-line shimmer short" style="height:12px;"></div>
    </div>
  `;

  const earned = document.getElementById("earned");
  earned.innerHTML = `<div class="loader-line shimmer" style="height:40px; width: 80px;"></div>`;
  const pending = document.getElementById("pending");
  pending.innerHTML = `<div class="loader-line shimmer" style="height:16px; width: 60px;"></div>`;
}


async function getRefs(){
  renderLoaderRefs();

  const cid = state.actId || (new URLSearchParams(location.search).get('contactId') || '').trim();
  if (!cid) {
    // no contact â†’ clear loader and show empty state
    state.referrals = [];
    state.earned = 0;
    state.pending = 0;
    renderMoney();
    renderRefs();
    return;
  }

  const url  = 'https://zoho-proxy.ephraim-7a6.workers.dev/referrals?contact_id=' + encodeURIComponent(cid);
  const res  = await fetch(url, { headers: { 'Content-Type': 'application/json' } });
  const data = await res.json();

  const items = (data && data.message && data.message.items)
    ? data.message.items
    : (Array.isArray(data?.items) ? data.items : []);

  // ðŸ‘‰ IMPORTANT: if zero items, clear loader & show "No referrals yet"
  if (!items.length) {
    state.referrals = [];
    state.earned = 0;
    state.pending = 0;
    renderMoney();   // put back $0 / $0 instead of skeleton divs
    renderRefs();    // this will render the "No referrals yet." row
    return;
  }

  state.referrals = items.map(item => {
    const status = item.Type === 'DealWon' ? 'Signed Up' : 'Pending';
    const earned = Number(item.Referral_Amount || 0) || 0;
    const type   = mapTypeByMethod(item.Referral_Method);
    return {
      name:  item.Name  || '',
      phone: item.Phone || '',
      email: item.Email || '',
      status,
      earned,
      type,                       // inreach | outreach
      methodRaw: item.Referral_Method || ''
    };
  });

  // normalize legacy types
  state.referrals = state.referrals.map(r => ({ ...r, type: normalizeType(r.type) }));

  recalcTotals();
  renderRefs();
}


function valueForEarnings(r){
  // If Closed Won has a numeric amount, use it; otherwise default to the base rate by direction
  const amt = Number(r.earned || 0);
  return amt > 0 ? amt : baseRateFor(r.type);
}

function recalcTotals(){
  const won = state.referrals.filter(r => r.status === 'Signed Up');
  state.earned = won.reduce((sum, r) => sum + valueForEarnings(r), 0);

  const pending = state.referrals.filter(r => r.status !== 'Signed Up');
  const pipeline = pending.reduce((sum, r) => sum + baseRateFor(r.type), 0);

  state.pending = pipeline + (Number(state.estimate) || 0);
  renderMoney();
}



function renderRefs(){
  const list = document.getElementById("refList");
  list.innerHTML = "";
  if (state.referrals.length === 0){
    const row = document.createElement("div");
    row.className = "item muted";
    row.innerHTML = `<span>No referrals yet.</span><span></span>`;
    list.appendChild(row);
    return;
  }

  const fmt = n => `$${Number(n).toLocaleString(undefined, { maximumFractionDigits: 2 })}`;

  state.referrals.forEach(r => {
    const label  = directionLabel(r.type);
    const amount = displayAmountFor(r);

    const row = document.createElement("div");
    row.className = "item";
const isSigned = r.status === 'Signed Up';
const badgeClass = isSigned ? 'badge badge-success' : 'badge';

row.innerHTML = `<div>
    <div><strong>${r.name}</strong> <span class="muted">(${r.phone})</span></div>
    <div class="muted">${r.email || ""}</div>
  </div>
  <div style="text-align:right">
    <div><span class="${badgeClass}">${r.status}</span></div>
    <div class="muted" style="margin-top:4px; font-size:12px">${label} â€¢ ${fmt(amount)}</div>
  </div>`;
    list.appendChild(row);
  });
}

function normalizeType(t){
  const x = String(t || '').toLowerCase();
  if (x === 'inreach' || x === 'pre') return 'inreach';
  if (x === 'outreach' || x === 'cold') return 'outreach';
  return 'inreach'; // default
}

// Default to inreach unless explicitly "Name Only"
function mapTypeByMethod(method){
  const m = String(method || '').trim().toLowerCase();
  if (m === 'name only') return 'outreach';
  return 'inreach';
}

function directionLabel(t){
  const norm = normalizeType(t);
  return norm === 'inreach' ? 'They reached out' : 'We reached out';
}

function baseRateFor(t){
  const norm = normalizeType(t);
  return norm === 'inreach' ? RATE_PRE : RATE_COLD;
}

function displayAmountFor(ref){
  const earned = Number(ref.earned || 0);
  if (earned > 0) return earned;     // prefer actual amount from deal
  return baseRateFor(ref.type);      // else show base rate for direction
}


    // Simulated fetch - replace with real API call
    // For demo purposes, we use static data
    //fetch     const out = await fetchVRP(cid, generate);
//     async function fetchVRP(contactId, generate = false) {
//   const url = 'https://zoho-proxy.ephraim-7a6.workers.dev/referrallink';
//   const res = await fetch(url, {
//     method: 'POST',
//     headers: { 'Content-Type': 'application/json' },
//     body: JSON.stringify({ contact_id: String(contactId), generate: !!generate })
//   });
//   const data = await res.json();
//   if (data.status === 'ok') return { ok: true, url: data.url || null, message: data.message };
//   return { ok: false, error: data.message || 'Unknown error' };
// }

function updateEstimate(){
  const n = parseInt(document.getElementById("countRange").value, 10);
  const type = document.getElementById("refType").value;
  document.getElementById("countVal").textContent = String(n);
  const ladder = type === "pre" ? MILESTONES_PRE : MILESTONES_COLD;
  document.getElementById("bonusNote").textContent = ladderText(ladder);
  document.getElementById("estimate").textContent = calcEstimate(n, type);
  // No change to KPI numbers
}


  // ---------- VRP via backend proxy ----------
  // Your backend endpoint must call the Zoho function and normalize result:
  //  POST /api/vrp { contactId, generate }
  //  -> { ok:true, url:"https://viewpointlearn.com/apply?vrp=ABCDE" } OR { ok:false, error:"Error generating referral link" }
async function fetchVRP(contactId, generate = false) {
  const url = 'https://zoho-proxy.ephraim-7a6.workers.dev/referrallink';
  const res = await fetch(url, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ contact_id: String(contactId), generate: !!generate })
  });
  const data = await res.json();
  if (data.status === 'ok') return { ok: true, url: data.url || null, message: data.message };
  return { ok: false, error: data.message || 'Unknown error' };
}






  function wireShareTargets(link){
    const openBtn = document.getElementById('openLinkBtn');
    const copyBtn = document.getElementById('copyBtn');
    const waBtn   = document.getElementById('waBtn');
    const smsBtn  = document.getElementById('smsBtn');

    openBtn.href = link;

    copyBtn.onclick = async () => {
      try { await navigator.clipboard.writeText(link); }
      catch {
        const ta = document.createElement('textarea');
        ta.value = link; document.body.appendChild(ta); ta.select();
        try { document.execCommand('copy'); } catch(_) {}
        document.body.removeChild(ta);
      }
      flash();
    };

    const msg = encodeURIComponent(`I recommend Viewpointâ€™s womenâ€™s cohort. Quick advisor link: ${link}`);
    waBtn.href  = `https://wa.me/?text=${msg}`;
    smsBtn.href = `sms:?&body=${msg}`;
  }

  function showShareUI({ link, loading=false, showGenerate=false, showRetry=false, message='', isEerror=false }){
    const refLink   = document.getElementById('refLink');
    const status    = document.getElementById('linkStatus');
    const openBtn   = document.getElementById('openLinkBtn');
    const copyBtn   = document.getElementById('copyBtn');
    const waBtn     = document.getElementById('waBtn');
    const smsBtn    = document.getElementById('smsBtn');
    const genBtn    = document.getElementById('generateBtn');
    const retryBtn  = document.getElementById('retryBtn');

    refLink.textContent = link || '';
    status.textContent  = loading ? 'Checking for your linkâ€¦' : message || '';
    status.className    = isEerror ? 'text-warning' : 'muted';

    openBtn.style.display = link ? '' : 'none';
    copyBtn.style.display = link ? '' : 'none';
    waBtn.style.display   = link ? '' : 'none';
    smsBtn.style.display  = link ? '' : 'none';

    genBtn.style.display  = showGenerate ? '' : 'none';
    retryBtn.style.display= showRetry ? '' : 'none';
  }

  async function initOrGenerateVRP({ generate = false } = {}) {
  const cid = state.actId || (new URLSearchParams(location.search).get('contactId') || '').trim();
  if (!cid) {
    showShareUI({ message: 'No contact selected.', isEerror: true });
    return;
  }

  try {
    showShareUI({ loading: true });

    const out = await fetchVRP(cid, generate);
    // 1) Readable success with url
    if (out && out.ok && out.url && !/Error generating referral link/i.test(out.url)) {
      showShareUI({ link: out.url, message: '' }); //Your link is ready.
      wireShareTargets(out.url);
      // flash();
      return;
    }

    // 2) Readable state machine (if/when your proxy returns status)
    if (out && out.ok && out.status) {
      if ( out.status === 'created') { //out.status === 'exists' ||
        showShareUI({ link: out.url, message: ''}); //, message: 'Your link is ready.' 
        wireShareTargets(out.url);
        flash();
        return;
      }
    }

    // 3) Opaque mode (no-cors) fallback
    if (out && out.ok && out.opaque) {
      if (generate) {
        // We just asked to generate but cannot read response.
        // Tell the user weâ€™re generating and auto-check once after a short delay.
        showShareUI({ message: 'Generatingâ€¦', showRetry: false, showGenerate: false });
        setTimeout(() => initOrGenerateVRP({ generate: false }), 1500);
      } else {
        // Initial check with opaque response: canâ€™t tell. Offer Generate.
        showShareUI({ message: 'No link on file.', showGenerate: true });
      }
      return;
    }

    // Explicit readable error
    //if the error contains No contact 

    const err = (out && out.error) || 'Could not get referral link.';
    showShareUI({
      message: err,
      showGenerate: !generate,
      showRetry: !!generate,
      isEerror: true
    });

  } catch (e) {
    showShareUI({ message: 'Network error. Please try again.', showRetry: true, isEerror: true });
  }
}


  // ---------- smart-fit tooltip (keeps bubbles in viewport) ----------
  (function(){
    const margin = 8;
    document.querySelectorAll('.tooltip-wrapper').forEach(wrap=>{
      const bub = wrap.querySelector('.tooltip-bubble');
      if(!bub) return;

      function positionBubble(){
        bub.style.visibility = 'hidden';
        bub.style.display = 'block';
        bub.removeAttribute('data-placement');
        bub.style.left = '50%';
        bub.style.transform = 'translateX(-50%)';

        let r = bub.getBoundingClientRect();

        if (r.top < margin){
          bub.setAttribute('data-placement','bottom');
          r = bub.getBoundingClientRect();
        }

        let offsetX = 0;
        if (r.right > window.innerWidth - margin){
          offsetX = (window.innerWidth - margin) - r.right;
        } else if (r.left < margin){
          offsetX = margin - r.left;
        }

        const isBottom = bub.getAttribute('data-placement') === 'bottom';
        const y = isBottom ? 4 : -4;
        bub.style.transform = `translateX(calc(-50% + ${offsetX}px)) translateY(${y}px)`;

        bub.style.visibility = '';
        bub.style.display = '';
      }

      wrap.addEventListener('mouseenter', positionBubble);
      ['scroll','resize'].forEach(ev=>{
        window.addEventListener(ev, ()=> {
          if (getComputedStyle(bub).visibility === 'visible') positionBubble();
        }, { passive:true });
      });
    });
  })();

  // ---------- Flow submit (referrals we reach out to) ----------
  async function submitReferral(payload){
    // Use your existing Flow/Creator/CRM webhook via your backend if possible.
    // This sample posts directly to Flow; switch to your own proxy for CORS-free reads.
    const flat = new URLSearchParams();
    flat.set('ref_code', payload.ref_code);
    if (payload.contact_id) flat.set('contact_id', payload.contact_id);
    flat.set('type', payload.type);
    flat.set('source', payload.source || 'referral_hub');
    flat.set('ts', payload.ts);
    if (payload.referrer_email) flat.set('referrer_email', payload.referrer_email);
    flat.set('prospect_name',  payload.prospect.name || '');
    flat.set('prospect_phone', payload.prospect.phone || '');
    flat.set('prospect_email', payload.prospect.email || '');

    try {
      await fetch("https://flow.zoho.com/756547289/flow/webhook/incoming?zapikey=1001.031e7ff6723e247a1fcb76e0f034da32.82a1c9376679cdffa874abf4bd63dc4a&isdebug=false", {
        method: "POST",
        headers: { "Content-Type": "application/x-www-form-urlencoded;charset=UTF-8" },
        body: flat.toString(),
        mode: "no-cors"
      });
      return { ok: true, opaque: true };
    } catch (e) {
      console.error(e);
      return { ok: false, error: 'NETWORK' };
    }
  }

  // ---------- tabs ----------
  const tabCold   = document.getElementById("tab-cold");
  const tabPre    = document.getElementById("tab-pre");
  const panelCold = document.getElementById("panel-cold");
  const panelPre  = document.getElementById("panel-pre");
  function selectTab(which){
    const cold = which === "cold";
    tabCold.setAttribute("aria-selected", cold ? "true" : "false");
    tabPre.setAttribute("aria-selected",  cold ? "false" : "true");
    panelCold.classList.toggle("active", cold);
    panelPre.classList.toggle("active",  !cold);
  }
  tabCold.addEventListener("click", ()=>selectTab("cold"));
  tabPre.addEventListener("click",  ()=>selectTab("pre"));

  // ---------- estimator ----------
  document.getElementById("countRange").addEventListener("input", updateEstimate);
  document.getElementById("refType").addEventListener("change", e=>{
    if(e.target.value === "pre") confetti({particleCount:60, spread:60, origin:{y:0.7}});
    updateEstimate();
  });

  // ---------- submit contact ----------
document.getElementById("addBtn").addEventListener("click", async () => {
  const btn   = document.getElementById("addBtn");
  const name  = document.getElementById("prospectName").value.trim();
  const phone = document.getElementById("prospectPhone").value.replace(/[^\d+]/g, "");
  const email = document.getElementById("prospectEmail").value.trim();

  if (!name || !phone) { alert("Name and phone are required."); return; }

  // prevent double clicks
  btn.disabled = true;

  const payload = {
    ref_code: state.refCode,
    contact_id: state.actId,
    referrer_email: state.referrerEmail,
    type: "cold",                 // outbound submission
    prospect: { name, phone, email },
    source: "referral_hub",
    ts: new Date().toISOString()
  };

  try {
    const res = await submitReferral(payload);
    if (res && res.ok) {
      // local echo: pending outreach item
      state.referrals.unshift({
        name, phone, email,
        status: "Pending",
        type: "outreach",
        earned: 0
      });

      recalcTotals();   // recomputes earned/pending/potential from state
      renderRefs();
      flash();

      // milestone confetti
      const c = state.referrals.length;
      if ([1, 3, 5, 10].includes(c)) {
        confetti({ particleCount: 220, spread: 80, origin: { y: 0.6 } });
      }

      // reset form
      document.getElementById("prospectName").value  = "";
      document.getElementById("prospectPhone").value = "";
      document.getElementById("prospectEmail").value = "";
    } else {
      alert("Could not add referral. Try again.");
    }
  } catch (e) {
    console.error(e);
    alert("Network error. Try again.");
  } finally {
    btn.disabled = false;
  }
});


  // ---------- share tab buttons ----------
  document.getElementById('generateBtn').addEventListener('click', ()=> initOrGenerateVRP({ generate:true }));
  document.getElementById('retryBtn').addEventListener('click',    ()=> initOrGenerateVRP({ generate:true }));

  // ---------- init ----------
  renderMoney();
  getRefs();
  // renderRefs();
  // updateEstimate();
  // On load: check for existing link (no generation)
  initOrGenerateVRP({ generate:false });
</script>
</body>
</html>
